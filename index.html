<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flatpickr with Prices</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@200..1000&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Nunito", sans-serif;
        font-style: normal;
        background-color: #f9f9f9;
        margin: 0;
        padding: 20px;
      }
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      #overlay.show {
        opacity: 1;
        visibility: visible;
      }
      .flatpickr-day {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        position: relative;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        padding: 0;
        font-size: 14px;
        line-height: 1;
        overflow: hidden;
        transition: background-color 0.3s, transform 0.2s;
      }

      .flatpickr-day:hover {
        background-color: #f0f8ff;
        transform: scale(1.1);
      }

      .price-label {
        margin-top: 2px;
        font-size: 10px;
        color: #666;
        text-align: center;
      }

      .flatpickr-day.price-low {
        background-color: #d4f8e8 !important;
      }

      .flatpickr-day.price-middle {
        background-color: #fff3cd !important;
      }

      .flatpickr-day.price-high {
        background-color: #f8d7da !important;
      }

      #min-nights-popup {
        display: none;
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .selected-dates {
        margin-top: 20px;
        font-size: 16px;
      }
      #room-list {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }
      /* Основной контейнер карточки */
      .room-item {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        border: 1px solid #ddd;
        background-color: #fff;
        max-width: 700px;
      }

      /* Изображение слева */
      .room-item img {
        object-fit: cover;
      }

      /* Правая сторона карточки */
      .room-content {
        display: flex;
      }

      .room-details {
        display: flex;
        flex-direction: column;
        padding: 10px;
        border-left: 1px solid #ddd;
        flex-grow: 1;
      }

      .room-details h3 {
        font-size: 1.4em;
        margin: 0;
        margin-bottom: 8px;
        color: #333;
      }

      .room-details p {
        margin: 0;
        font-size: 1em;
        color: #555;
      }

      .room-details ul {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 0;
        margin: 0;
        list-style: none;
        margin-top: auto;
      }

      .room-details ul li {
        background-color: #f0f0f0; /* опционально: фон для элементов */
        padding: 5px 10px;
        border-radius: 5px; /* опционально: закругленные углы */
        font-size: 0.9em; /* изменяем размер текста */
        color: #333;
      }
      /* Блок с ночами и людьми */
      .room-meta {
        font-size: 0.9em;
        color: #555;
        margin-top: 10px;
      }

      .room-price-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 60px;
        border-top: 1px solid #ddd;
        width: 100%; /* Растягивает блок на всю ширину родителя */
        box-sizing: border-box; /* Учитывает padding и border в ширине */
        padding: 10px 20px; /* Добавляем небольшой отступ сверху для эстетики */
      }

      .room-price {
        text-align: left;
      }

      .room-price .total-price {
        font-size: 1.2em;
        font-weight: bold;
        color: #2a9d8f;
        margin: 0;
      }

      .room-price .price-per-person {
        font-size: 0.9em;
        color: #555;
        margin: 0;
      }

      .room-actions {
        display: flex;
        gap: 20px;
      }
      .room-actions p {
        font-size: 0.9em;
        color: #555;
      }
      /* Кнопка "Выбрать" */
      .room-actions button {
        padding: 10px 20px; /* Увеличиваем размер */
        font-size: 1.1em; /* Немного увеличиваем шрифт */
        font-weight: bold;
        color: #fff; /* Текст белый */
        background-color: #2a9d8f; /* Основной цвет кнопки */
        border: none;
        border-radius: 4px; /* Более округлые края */
        cursor: pointer;
        transition: all 0.3s ease; /* Плавный переход для всех изменений */
      }

      .room-actions button:hover {
        background-color: #21867a; /* Цвет темнее при наведении */
        transform: scale(1.05); /* Легкое увеличение при наведении */
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); /* Увеличение тени */
      }

      .room-actions button:active {
        transform: scale(0.95); /* Легкое уменьшение при клике */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); /* Уменьшение тени */
      }
    </style>
  </head>
  <body>
    <button id="open-calendar">Open Calendar</button>
    <div id="overlay">
      <div>
        <button id="close-calendar">Close Calendar</button>
        <div id="calendar-container"></div>
        <button id="submit-dates" disabled>Check Rooms</button>
      </div>
    </div>

    <div id="min-nights-popup">
      <span id="min-nights-text"></span>
    </div>

    <div class="selected-dates" id="selected-dates">
      <p>Select your dates:</p>
      <p id="check-in">Check-in: N/A</p>
      <p id="check-out">Check-out: N/A</p>
    </div>
    <div id="room-list"></div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
      const openCalendarButton = document.getElementById("open-calendar");
      const closeCalendarButton = document.getElementById("close-calendar");
      const overlay = document.getElementById("overlay");
      const calendarContainer = document.getElementById("calendar-container");
      const submitDatesButton = document.getElementById("submit-dates");

      const checkInText = document.getElementById("check-in");
      const checkOutText = document.getElementById("check-out");
      const roomList = document.getElementById("room-list");

      let calendarInstance = null;
      let selectedDates = [];

      openCalendarButton.addEventListener("click", () => {
        overlay.classList.add("show");

        if (!calendarInstance) {
          const calendarInput = document.createElement("input"); // Динамически создаем input
          calendarInput.id = "calendar"; // Добавляем ID для Flatpickr
          calendarContainer.appendChild(calendarInput);

          initCalendar(); // Инициализируем календарь
        }
      });

      closeCalendarButton.addEventListener("click", () => {
        overlay.classList.remove("show");

        if (calendarInstance) {
          calendarInstance.destroy(); // Уничтожаем инстанс Flatpickr
          calendarInstance = null;

          // Удаляем input календаря, чтобы скрыть его из DOM
          calendarContainer.innerHTML = "";
        }
      });
      async function fetchAvailability() {
        const url =
          "https://api.travelcircus.net/hotels/17080/checkins?E&party=%7B%22adults%22:2,%22children%22:%5B%5D%7D&domain=de&date_start=2025-01-01&date_end=2025-06-31";
        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Response status: ${response.status}`);
          }

          const data = await response.json();
          return data._embedded.hotel_availabilities.map((item) => ({
            date: item.date,
            price: item.price,
            min_nights: item.min_nights,
            price_position: item.price_position,
          }));
        } catch (error) {
          console.error("Error fetching availability:", error.message);
          return [];
        }
      }

      async function initCalendar() {
        const availability = await fetchAvailability();

        const availableDates = availability.map((day) => day.date);
        const availabilityMap = availability.reduce((map, day) => {
          map[day.date] = day;
          return map;
        }, {});

        calendarInstance = flatpickr("#calendar", {
          dateFormat: "Y-m-d",
          inline: true,
          enable: availableDates,
          mode: "range",
          onChange: (dates) => {
            selectedDates = dates;
            if (dates.length === 2) {
              const checkIn = dates[0].toLocaleDateString("en-CA");
              const checkOut = dates[1].toLocaleDateString("en-CA");
              checkInText.textContent = `Check-in: ${checkIn}`;
              checkOutText.textContent = `Check-out: ${checkOut}`;
              submitDatesButton.disabled = false;
            }
          },
          onDayCreate: (dObj, dStr, fp, dayElem) => {
            const date = fp.formatDate(dayElem.dateObj, "Y-m-d");
            const dayData = availabilityMap[date];
            if (dayData) {
              const priceLabel = document.createElement("span");
              priceLabel.classList.add("price-label");
              priceLabel.textContent = `$${dayData.price}`;
              dayElem.appendChild(priceLabel);
              dayElem.classList.add(`price-${dayData.price_position}`);
            }
          },
        });
      }
      submitDatesButton.addEventListener("click", async () => {
        if (selectedDates.length !== 2) return;

        const checkIn = selectedDates[0].toLocaleDateString("en-CA");
        const checkOut = selectedDates[1].toLocaleDateString("en-CA");
        console.log("In", checkIn);
        console.log("Out", checkOut);

        const url = `https://api.travelcircus.net/hotels/17080/quotes?locale=de_DE&checkin=${checkIn}&checkout=${checkOut}&party=%7B%22adults%22:2,%22children%22:[]%7D&domain=de`;

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Response status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Rooms", data._embedded.hotel_quotes);
          displayRooms(data._embedded.hotel_quotes);
          console.log("Here");
        } catch (error) {
          console.error("Error fetching rooms:", error.message);
        }
      });

      // Функция для отображения комнат
      function displayRooms(rooms) {
        console.log(rooms);
        const roomList = document.getElementById("room-list");
        roomList.innerHTML = "";

        rooms.forEach((room) => {
          console.log("hi");
          const roomDiv = document.createElement("div");
          roomDiv.classList.add("room-item");

          const imageUrl = room._embedded.pictures[0].offer_teaser_square;
          console.log(imageUrl);

          const amenitiesList = room._embedded.amenities
            .map((amenity) => `<li>${amenity.description}</li>`)
            .join("");
          console.log(amenitiesList);

          roomDiv.innerHTML = `
          <div class="room-content">
            <img src="${imageUrl}" alt="Room Image" />
            <div class="room-details">
              <h3>${room.name}</h3>
              <p>Room size: ${room.room_size_min} m²</p>
              <ul>${amenitiesList}</ul>
            </div>
          </div>
          <div class="room-price-section">
            <div class="room-price">
              <p class="total-price">${room.full_formatted_price}</p>
              <p class="price-per-person">
                Per person: ${room.full_price_pp} ${room.currency_symbol}
              </p>
            </div>
            <div class="room-meta">
              
            </div>
            <div class="room-actions">
              <p>${room.fullPriceBreakdown.nights} nights / 2 adults</p>
              <button>Select</button>
            </div>
          </div>`;
          roomList.appendChild(roomDiv);
        });
      }

      // Инициализация: загружаем комнаты
      // fetchRooms();
    </script>
  </body>
</html>
